schema.go
id.go
object_storage.go
fs.go
fs_dir.go
fs_database.go
creation_time.go
creation_time_darwin.go
creation_time_linux.go
creation_time_windows.go
notebrew.go
dev.go
site_generator.go
regenerate.go
site_json.go
postlist_json.go
rootdirectory.go
directory.go
pin.go
image.go
file.go
createsite.go
deletesite.go
createfolder.go
createfile.go
delete.go
search.go
rename.go
uploadfile.go
clipboard.go
serve_http.go

cli/config_cmd.go
cli/sqlite_cgo.go
cli/sqlite_nocgo.go
cli/cli.go
cli/createinvite_cmd.go
cli/createsite_cmd.go
cli/createuser_cmd.go
cli/deleteinvite_cmd.go
cli/deletesite_cmd.go
cli/deleteuser_cmd.go
cli/hashpassword_cmd.go
cli/permissions_cmd.go
cli/resetpassword_cmd.go
cli/start_cmd.go
cli/status_cmd.go
cli/stop_cmd.go

exit.go
exit_windows.go
open_browser.go
main.go

notebrew/exit.go
notebrew/exit_windows.go
notebrew/sqlite_cgo.go
notebrew/sqlite_nocgo.go
notebrew/server.go
notebrew/main.go
notebrew/open_browser.go

/users/signup/
/users/signup/?sessionID= (if the signup page also includes an embedded payment form)
/users/profile/
/users/billing/ => user can view their current plan as well as other plans (no payment form yet)
/users/updatebilling/ => user can change their plan, which kicks in the next year (payment form present)

signup simply sends an invite email. in spam lockdown mode, the user needs to complete a payment form instead (after returning, we can retrieve the email from the stripe session).

no comments (use disqus)
subscription-only
payment upfront, no trial so no spam. use it in offline or self-host if you want it to be cheaper (probably not)
easiest way to get started is to just mail them an invite link
*and yet,* I cannot shake myself of the feeling that the first 10 MB being free and payment for $18/year for 1 GB is the most user-friendly scheme of it all.
    so what if some people create spam sites? you can probably

== Initial ==
Sign up, 10 MB at first. Upgrade/change plan in the dashboard.
0 USD/year: 10 MB, 1 site
12 USD/year (or 1 USD/month): 1 GB, 3 sites
48 USD/year (or 4 USD/month): 6GB, 10 sites

----
0.48 USD => 1 GB storage
0.1 USD => 20 GB CDN bandwidth
----
Total cost: 0.58 USD (0.42 USD profit)

----
2.88 USD => 6 GB storage
0.6 USD => 120 GB bandwidth
----
Total cost: 3.48 USD (0.52 USD profit)

0.52 * 1666 = 866 USD profit / mo

== Spam lockdown mode ==
Immediately need to pick a plan. The sign up flow has to be rewritten from immediately letting the users in to immediately directing them to a payment page, only after payment will they be let in. If their username is already taken, keep it as null. If the site is already taken, don't create the site and let them create it manually. In all cases the user joins via an invite link sent to their email.
12 USD/year (or 1 USD/month): 1 GB, 3 sites
48 USD/year (or 4 USD/month): 6GB, 10 sites

moderator.notebrew.com/ => package moderator

cdn.nbrew.net pulls from storage.nbrew.net
videocdn.nbrew.net pulls from videostorage.nbrew.net

the admin page needs to:
- let me customize the shell script used to flag out bad sites
    - doesn't even have to be bad sites. it can fetch all unchecked sites in general. once a site is checked to be safe, it goes into the moderation database so that it doesn't have to be checked again.
    - oh: I should be able to write multiple scripts and be given the option to see each of their results. and then it's all deduplicated again in the spam database so each site is only inserted once.
- make sure to include the dates the bad site was created and when it was flagged into the database! this will be useful for analytics in the future.
- for each site flagged out by the shell script, give me a convenient link to browse the site's different pages.
- give me a button to delete a site (this dumps it into a backblaze bucket so that we can use it for future spam data training)
- give me a button to disable a user account
- through it all, all actions must be recorded down so that we know exactly which sites were deleted and who those sites belonged to (again for future data training, but it also lets us link a specific site to a specific object in the backblaze bucket). This means the spam database must be *persistent*!
- show me CDN usage by site (need to communicate with BunnyCDN's API). that's about it, since I doubt many users will trigger this check. if someone does, I can handle it manually first.

TODO: create a sessions table hat lets users manage their sessions. They can also generate new sessions, whereby the session token is shown once and then deleted.
    - profile => sessions => generate session token
    - TODO: /profile/ should show the current user's sessions
    - TODO: /createsession/ # notify the user that if they don't supply a label, they will not be able to edit it later on
    - TODO: /deletesession/
    - TODO: this means the authentication table needs a new column called "label", which stores the user agent by default if logging in from the website but is otherwise blank and can be filled in with anything if manually generated by the user.
TODO: for directory.html, for every directory show a new link called 'apply theme' which applies post.html, postlist.html and index.html if they exist.
    - TODO: /applytheme/: needs to check if the current theme folder has any valid template we can apply
        - TODO: the user can also choose between applying the theme for all categories or one specific category.
    - TODO: in site.json, we also need a 'reset theme' option which updates all post.html, postlist.html and index.html to their original format.
        - TODO: /resettheme/: similar to /applytheme/, the user can choose to reset themes for all categories or just one specific category.
TODO: signup.go
    TODO: in spam lockdown mode, if we're going to ask the user to pay upfront we're going to have to ask them to enter their credit card details *alongside* their username/email/site name, *and* we need dynamic verification via javascript so that they don't try to submit their credit card details with a faulty username/email address/site name.
TODO: export.go needs to take into account page and post assets when exporting (oh god this is complicated).
TODO: add a hash to the response headers so that clients can do a GET to synchronize their local copy with remote
TODO: tests
TODO: embed the tutorial as /files/tutorial/, and also embed the chroma style gallery as /files/chroma-style-gallery/
TODO: include handwritten API documentation, involving POST-ing to /login/.
    TODO: make sure to warn them if they get the password request wrong three times it will activate the captcha after which bots will likely break, this can be cleared by the user grabbing the

DNS testcases:
- Newly created server, no DNS entries configured. Set the cmsdomain to notebrew.com and contentdomain nbrew.io.
    - want: the server starts and listens on :443, but no servers should be provisioned since DNS resolution should have failed for the domains.
    - DONE
- Fresh server, no DNS entries. Set port to 80.
    - (if the user wants to test if their server can connect to the internet)
    - want: the server starts on :80 (no SSL certificates configured) using CMSDomain and ContentDomain set to the server's IP address, and everything behaves as it does on localhost (except without the subdomains).
    - DONE
- Fresh server, with DNS entry set to notebrew.com. Set port to 80, cmsdomain to notebrew.com.
    - (if the user wants to test if their DNS is configured correctly. only one record is required, either an @/A record or an @/AAAA record)
    - want: the server starts on :80 (no SSL certificates configured) CMSDomain and ContentDomain set to the same thing, and everything behaves as it does on localhost (except without the subdomains).
    - you are also no longer able to reach the site using the IP address, must use the domain name.
The main usefulness of being able to run notebrew on plain IP addresses or HTTP is that new users can run it first without worrying about any domain name configuration or SSL certificate configuration and ascertain if they can connect to their server in the first place.

# User tutorials #

- The main guide will be "if you know how to write HTML, just put HTML in these pages and they'll be included"
- The next guide will be "if you want to include CSS and JS and images, create/upload them via the input[type=file] and you can mention it by the name you created/uploaded it with"
- Then "if you want to use templates globally, put them in /themes/ and you can reference these templates everywhere with {{ template "/themes/.../xxx.html" }}
- Follow up with explaining that if you invoke an external template, all the internal templates for that external templates will also be brought into scope. If there are any template name conflicts, the local one wins.
- Then "likewise, if you want to reference images and assets globally, put them in /themes/ and you can reference these assets globally with src='/themes/.../xxx.jpeg' or src='/themes/.../xxx.js'"
- NOTE: need to insert an addenum: sometimes site generation may not be perfect, and miss out something. If you notice anything off, head into site.json and simply hit 'save' to regenerate your entire site from scratch.
- NOTE: inform the user of certain opinionated styles, for example HTML using single quotes instead of double quotes (so that double quotes can be used for HTML template string literals). As well as everything using two-spaced tabs so that it's easy to indent code even on mobile, which doesn't have a tab key and the best way is to hit spacebar twice instead of tab once.
    - Actually if we keep quiet on the opinionated style and mention how to escape double quotes it could also work.
    - Immediately after telling users how to escape double quotes, follow up with why notebrew follows the convention of single quotes in HTML instead of the more common double quotes.
- need to add the concept of permanent files to the guide
    permanent files: notes, pages, posts, output, site.json, pages/index.html, pages/404.html, posts/*/postlist.html, posts/*/post.html, posts/*/postlist.json
    affected actions: rename, cut, delete

# Using notebrew locally (as a static site generator, then push the output to SSG host) #

# Ops tutorial #

self hosting guide, starting from scratch/zero, does not assume any prior server knowledge (just good at following instructions)
step 0: can you purchase a VPS? Can you ssh into it/open a console and run commands?
step 1: can you download the binary? this is also how you update notebrew in the future, just redownload it. can it start?
step 2: can you talk to it over the internet using an ip address?
step 3: can you enable user accounts, create the default user and log in using the credentials?
step 4: can you talk to it over the internet using a domain name? (adding DNS records)
    step 4.5a: can you add a wildcard DNS record and connect to the site using www.{contentdomain}? Can you create a new site and connect to it using {siteName}.{contentdomain}? Can you then add a subdomain site?
    step 4.5b: can you add a new DNS record for a completely separate domain and connect to the site using {customDomain}? Can you then add a custom domain site?
step 5: can you talk to it over the internet using a domain name + SSL?
    - Note that it will prompt you to enter your email and stuff.
last step: can you make it run in the background? using start/stop or systemd. other methods like nohup or tmux are possible but if you know those things you probably don't need a tutorial for how to do it.

# Extra ops tutorials #

(for each step, also document how to undo it)
- switch from DirFS to DatabaseFS
    - switch database dialect from SQLite to Postgres or MySQL
    - switch from DirObjectStorage to S3ObjectStorage
- add a separate content domain
- add a CDN and img domain
- add an img cmd
- enable captcha for logins
- enable wildcard certificates using a DNS provider

# Admin tutorials #

admin steps:
- create a new invite (optionally with a site limit and storage limit) and let someone join
- delete existing invites
- generate a password reset link for somebody who has forgotten their password
- create sites
- create users
- assign sites to users (and optionally set the site owner) using the permissions command

notebrew permissions -user $user -site $site -grant -revoke -setowner
